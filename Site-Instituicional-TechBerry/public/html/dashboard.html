<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechBerry</title>

  <!-- Link do css, font-family e dos graficos em chart-js -->
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/styleMin3.css">
  <link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="../css/dashboardMin.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="header">
    <div class="headerA"></div>
    <div class="headerB">
      <img class="logo" src="../imagens\morango.png" alt="" onclick="location.href='../index.html'" />
      <ul class="lista">
        <li style="cursor: default;">Graficos da Dashboard</li>
      </ul>
    </div>
  </div>

  <!-- Aqui está as metricas do site, que ao clicar no botão de informação aparece as mesmas -->
  <img src="../imagens/info (1).png" onclick="mostrarMetricas()"
    style="height: 30px; position: fixed; margin-left: 50px; cursor: pointer;">
  <img id="tempMetrica" src="../imagens/temp.png" alt=""
    style="margin-left: 35%; display: none; position: fixed; z-index: 1;">
  <img id="umiMetrica" src="../imagens/umidade.png" alt=""
    style="margin-left: 6%;display: none; position: fixed; z-index: 1;">

  <!-- Aqui está a div para a renderização dos gráficos da estufa -->
  <div class="sensorContainers">
    <div class="canvasA">
      <div onclick="hide1()" id="sensorContainer1" class="sensorContainer1">
        <span style="position: fixed; color: rgb(255, 112, 112);">1°</span>
        <span class="graus" style="font-weight: 600;">26°C</span>
        <canvas id="canvas1" style="position: fixed; margin-top: -58px;"></canvas></div>
      <div onclick="hide2()" id="sensorContainer2" class="sensorContainer2">
        <span style="position: fixed; color: rgb(255, 112, 112);">2°</span>
        <span class="graus" style="font-weight: 600;">17°C</span>
        <canvas id="canvas2" style="position: fixed; margin-top: -58px;"></canvas></div>
      <div onclick="hide3()" id="sensorContainer3" class="sensorContainer3">
        <span style="position: fixed; color: rgb(255, 112, 112);">3°</span>
        <span class="graus" style="font-weight: 600;">18°C</span>
        <canvas id="canvas3" style="position: fixed; margin-top: -58px;"></canvas></div>
      <div onclick="hide4()" id="sensorContainer4" class="sensorContainer4">
        <span style="position: fixed; color: rgb(255, 112, 112);">4°</span>
        <span class="graus" style="font-weight: 600;">30°C</span>
        <span
          style="color: #000000; position: fixed; font-size: 200px; z-index: 1; opacity: 0.8; margin-left: 9.5%; margin-top: -30px;">!</span>
        <canvas id="canvas4" style="position: fixed; margin-top: -58px;;"></canvas></div>
    </div>
  </div>

  <!-- Aqui está os gráficos de determinadas estufas selecionadas -->
  <div onclick="mudarBotao1()" id="botao1" class="botao1">Temperatura</div>
  <div onclick="mudarBotao2()" id="botao2" class="botao2">Umidade</div>
  <div class="dadosContainer">
    <div><canvas id="canvas5" style="border-bottom: 2px solid #ffc3c3; margin-top: -8px; display: block;"></canvas>
    </div>
    <div><canvas id="canvas6" style="display: block;"></canvas></div>
  </div>

  <!-- Aqui está o footer do site -->
  <div class="beader">
    <div class="infoBeader">
      <ul class="listaBeader">
        <li onclick="location.href='emConstrução.html'">Quem Somos</li>
        <li onclick="location.href='emConstrução.html'">Fale Conosco</li>
        <li onclick="location.href='emConstrução.html'">Direitos</li>
        <li onclick="location.href='emConstrução.html'">Termos de Uso</li>
        <li onclick="location.href='emConstrução.html'">Politica de Privacidade</li>
        <li onclick="location.href='emConstrução.html'">Politica de Hiperlinks</li>
        <li onclick="location.href='emConstrução.html'">English Version</li>
      </ul>
      © 2022–2022 TechBerry.®, Inc. Todos os direitos reservados.
    </div>
    <script src="../javascript/mouseOver.js"></script> <!-- verificação do footer -->
    <script>

      infoM = 0

      function mostrarMetricas() {
        infoM++
        // aqui está a verificação de métricas, se o botão de info for clicado ela aparece se não ela desaparece.
        if (infoM % 2 == 0) {
          tempMetrica.style.display = 'none'
          umiMetrica.style.display = 'none'
        } else {
          tempMetrica.style.display = 'block'
          umiMetrica.style.display = 'block'
        }
      }
      h1 = 1
      h2 = 0
      h3 = 0
      h4 = 0

      function hideTemperatura() {
        // aqui estamos escondendo todas os graficos específicos de alguma estufa de temperatura
        canvas5.style.display = 'none'
        canvas6.style.display = 'none'
      }

      function mudarBotao1() {
        // se o botão de temperatura for clicado muda a cor dele e a cor do de umidade.
        botao1.style.backgroundColor = 'rgb(255, 80, 80)'
        botao2.style.backgroundColor = 'rgb(255, 112, 112)'

        if (h1 == 1) {
          // se a primeira estufa for a selecionada faz aparecer os gráficos especificos de temperatura
          hideUmidade()
          canvas5.style.display = 'block'
          canvas6.style.display = 'block'
        } else if (h2 == 1) {
          // basicamente a mesma coisa que o primeiro if só muda o fato que se for a segunda estufa selecionada
          hideUmidade()
          canvas5.style.display = 'none'
          canvas6.style.display = 'none'
        } else if (h3 == 1) {
          // 3 estufa selecionada
          hideUmidade()
          canvas5.style.display = 'none'
          canvas6.style.display = 'none'
        } else if (h4 == 1) {
          // 4 estufa selecionada
          hideUmidade()
          canvas5.style.display = 'none'
          canvas6.style.display = 'none'
        }
      }

      function mudarBotao2() {
        // se o botão de umidade for clicado ele muda a cor do botão de temperatura e a dele para cores diferentes.
        botao1.style.backgroundColor = 'rgb(255, 112, 112)'
        botao2.style.backgroundColor = 'rgb(255, 80, 80)'
        if (h1 == 1) {
          hideTemperatura()
          // aqui estamos escondendo os graficos de temperatura e mostrando os de umidade.
        } else if (h2 == 1) {
          hideTemperatura()
        } else if (h3 == 1) {
          hideTemperatura()
        } else if (h4 == 1) {
          hideTemperatura()
        }
      }

      function esconder() {
        // aqui estamos escondendo os gráficos de temperatura.
        canvas5.style.display = 'none'
        canvas6.style.display = 'none'
      }

      function hide1() {
        // aqui estamos escondendo os gráficos e mudando a cor da borda do sensor selecionado.
        h1 = 1
        h2 = 0
        h3 = 0
        h4 = 0
        sensorContainer1.style.borderColor = '#ff3232'
        sensorContainer2.style.borderColor = '#ffc3c3'
        sensorContainer3.style.borderColor = '#ffc3c3'
        sensorContainer4.style.borderColor = '#ffc3c3'
        hideUmidade()
        canvas5.style.display = 'block'
        canvas6.style.display = 'block'
        botao1.style.backgroundColor = 'rgb(255, 80, 80)'
        botao2.style.backgroundColor = 'rgb(255, 112, 112)'
      }

      function hide2() {
        // aqui estamos escondendo os gráficos e mudando a cor da borda do sensor selecionado.
        h1 = 0
        h2 = 1
        h3 = 0
        h4 = 0
        sensorContainer1.style.borderColor = '#ffc3c3'
        sensorContainer2.style.borderColor = '#ff3232'
        sensorContainer3.style.borderColor = '#ffc3c3'
        sensorContainer4.style.borderColor = '#ffc3c3'
        hideUmidade()
        canvas5.style.display = 'none'
        canvas6.style.display = 'none'
        botao1.style.backgroundColor = 'rgb(255, 80, 80)'
        botao2.style.backgroundColor = 'rgb(255, 112, 112)'
      }

      function hide3() {
        // aqui estamos escondendo os gráficos e mudando a cor da borda do sensor selecionado.
        h1 = 0
        h2 = 0
        h3 = 1
        h4 = 0
        sensorContainer1.style.borderColor = '#ffc3c3'
        sensorContainer2.style.borderColor = '#ffc3c3'
        sensorContainer3.style.borderColor = '#ff3232'
        sensorContainer4.style.borderColor = '#ffc3c3'
        hideUmidade()
        canvas5.style.display = 'none'
        canvas6.style.display = 'none'
        botao1.style.backgroundColor = 'rgb(255, 80, 80)'
        botao2.style.backgroundColor = 'rgb(255, 112, 112)'
      }

      function hide4() {
        // aqui estamos escondendo os gráficos e mudando a cor da borda do sensor selecionado.
        h1 = 0
        h2 = 0
        h3 = 0
        h4 = 1
        sensorContainer1.style.borderColor = '#ffc3c3'
        sensorContainer2.style.borderColor = '#ffc3c3'
        sensorContainer3.style.borderColor = '#ffc3c3'
        sensorContainer4.style.borderColor = '#ff3232'
        hideUmidade()
        canvas5.style.display = 'none'
        canvas6.style.display = 'none'
        botao1.style.backgroundColor = 'rgb(255, 80, 80)'
        botao2.style.backgroundColor = 'rgb(255, 112, 112)'
      }
    </script>
    <script>
      // esse script serve para a renderização dos gráficos na tela.
      var ctx2 = document.getElementById("canvas1");
      var dashboardChart2 = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          datasets: [{
            label: '# of Votes',
            data: [28, 3],
            backgroundColor: [
              'rgb(255, 72, 0)',
              'white'
            ],
            borderWidth: 0
          }]

        },
        options: {
          rotation: 86 * Math.PI,
          /** This is where you need to work out where 89% is */
          circumference: 57.2 * Math.PI,
          /** put in a much smaller amount  so it does not take up an entire semi circle */
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          },
          cutoutPercentage: 50,
          tooltips: false,
        }
      }, );
    </script>
    <script>
      var ctx2 = document.getElementById("canvas2");
      var dashboardChart2 = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          datasets: [{
            label: '# of Votes',
            data: [10, 10],
            backgroundColor: [
              'rgb(72, 255, 0)',
              'white'
            ],
            borderWidth: 0
          }]

        },
        options: {
          rotation: 86 * Math.PI,
          /** This is where you need to work out where 89% is */
          circumference: 57.2 * Math.PI,
          /** put in a much smaller amount  so it does not take up an entire semi circle */
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          },
          cutoutPercentage: 50,
          tooltips: false,
        }
      }, );
    </script>
    <script>
      var ctx2 = document.getElementById("canvas3");
      var dashboardChart2 = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          datasets: [{
            label: '# of Votes',
            data: [14, 10],
            backgroundColor: [
              'rgb(251, 255, 0)',
              'white'
            ],
            borderWidth: 0
          }]

        },
        options: {
          rotation: 86 * Math.PI,
          /** This is where you need to work out where 89% is */
          circumference: 57.2 * Math.PI,
          /** put in a much smaller amount  so it does not take up an entire semi circle */
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          },
          cutoutPercentage: 50,
          tooltips: false,
        }
      }, );
    </script>
    <script>
      var ctx2 = document.getElementById("canvas4");
      var dashboardChart2 = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          datasets: [{
            label: '# of Votes',
            data: [14],
            backgroundColor: [
              'rgb(255, 0, 0)',
              'white'
            ],
            borderWidth: 0
          }]

        },
        options: {
          rotation: 86 * Math.PI,
          /** This is where you need to work out where 89% is */
          circumference: 57.2 * Math.PI,
          /** put in a much smaller amount  so it does not take up an entire semi circle */
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          },
          cutoutPercentage: 50,
          tooltips: false,
        }
      }, );
    </script>
    </script>
    <script>
      const labels4 = [
        '08/04',
        '09/04',
        '10/04',
        '11/04',
        '12/04',
        '13/04',
      ];

      const data4 = {
        labels: labels4,
        datasets: [{
          label: 'Temperatura Minima',
          backgroundColor: 'rgba(0,174,255,1)',
          borderColor: 'rgb(255, 99, 132)',
          data: [3, 4, 2, 10, 1, 6, 20],
        }]
      };

      const config4 = {
        type: 'bar',
        data: data4,
        options: {}
      };
    </script>
    <script>
      const labels2 = [
        '08/04',
        '09/04',
        '10/04',
        '11/04',
        '12/04',
        '13/04',
      ];

      const data2 = {
        labels: labels2,
        datasets: [{
          label: 'Temperatura Minima',
          backgroundColor: 'rgba(0,174,255,1)',
          borderColor: 'rgb(255, 99, 132)',
          data: [6, 10, 9, 7, 5, 6, 20],
        }]
      };

      const config2 = {
        type: 'bar',
        data: data2,
        options: {}
      };
    </script>
    <script>
      const myChart2 = new Chart(
        document.getElementById('canvas6'),
        config2
      );
    </script>

    <script>
      let proximaAtualizacao;

      window.onload = obterDadosGrafico(1);

      function obterDadosGrafico(idAquario) {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        console.log(idAquario);

        fetch(`/medidas/ultimas/${idAquario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idAquario);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idAquario) {
        console.log('iniciando plotagem do gráfico...');

        var dados = {
            labels: [],
            datasets: [
                {
                    label: 'Temperatura Maxima',
                    borderColor: '#32B9CD',
                    backgroundColor: '#FF0000',
                    data: []
                },
                {
                    label: 'Temperatura Minima',
                    borderColor: '#FFF',
                    backgroundColor: '#00FFFF',
                    data: []
                }
            ]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.max_temp);
            dados.datasets[1].data.push(registro.min_temp);
        }

        console.log(JSON.stringify(dados));

        var ctx = canvas5.getContext('2d');
        window.grafico_linha = new Chart(ctx, {
            type: 'bar',
            data: dados,
            options: {
                responsive: true,
                hoverMode: 'index',
                title: {
                    display: false,
                    text: 'Dados capturados'
                },
                scales: {
                    yAxes: [{
                        type: 'bar',
                        display: true,
                        position: 'left',
                    }, {
                        type: 'bar',
                        display: true,
                        position: 'right',

                    }],
                }
            }
        });

        setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idAquario, dados) {

        fetch(`/medidas/tempo-real/${idAquario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico: ${dados}`);

                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
                    
                    dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                    dados.datasets[0].data.push(novoRegistro[0].max_temp); // incluir uma nova medida de umidade
                    
                    dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[1].data.push(novoRegistro[0].min_temp); // incluir uma nova medida de temperatura

                    window.grafico_linha.update();

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
    </script>